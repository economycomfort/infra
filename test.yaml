---
## Random plays for testing.

  - hosts: chunky
    
    pre_tasks:
      - name: Gathering facts about ZFS datasets
        become: yes
        community.general.zfs_facts:
          dataset: "{{ item.name }}"
          recurse: false
        loop: "{{ zdatasets }}"
        register: dab_datasets

      - set_fact:
          mount_status: "{{ dab_datasets.results | map(attribute='ansible_facts') | flatten | map(attribute='ansible_zfs_datasets') | flatten | map(attribute='mounted') }}"
          mount_name: "{{ zdatasets | map(attribute='name') }}"

      - name: Fail if a ZFS dataset is not mounted.
        fail:
          msg: "{{ mount_name[ansible_loop.index0] }} is not mounted!"
        loop: "{{ mount_name }}"
        loop_control: 
          extended: true
        when: mount_status[ansible_loop.index0] == 'no'


    roles:
      #- vladgh.samba.server